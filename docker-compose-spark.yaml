version: '3'

x-spark-worker:
  cpus: 0.5
  environment:
    &spark-worker-env
    SPARK_MASTER : spark://spark-master:7077
    SPARK_WORKER_CORES : 1
    SPARK_WORKER_MEMORY : 1G
    SPARK_DRIVER_MEMORY : 512MB
    SPARK_EXECUTOR_MEMORY : 512MB
    SPARK_WORKLOAD : worker

  depends_on:
    &spark-worker-depends-on
    spark-master:
      condition: service_healthy

x-spark-common:
  &spark-common
  image: ${SPARK_IMAGE:-cluster-apache-spark:3.0.2}
  volumes:
    - ./bash:/opt/bash
    - ./data:/opt/spark-data
    - ./src:/opt/spark-apps
    - ./src/test:/opt/spark-apps/test

services:

  spark-master:
    <<: *spark-common
    ports:
      - "8000:8000"
      - "9090:8080"
      - "7077:7077"
      - "80:80"
    environment:
      - SPARK_LOCAL_IP=spark-master
      - SPARK_WORKLOAD=master
    healthcheck:
      test: "curl --fail --silent  http://spark-master:8080 || exit 1"
      interval: 5s
      timeout: 3s
      retries: 3

  spark-worker-a:
    <<: *spark-common
    environment:
      <<: *spark-worker-env
      SPARK_LOCAL_IP: spark-worker-a
    ports:
      - "9091:8080"
      - "7001:7000"
    depends_on:
      <<: *spark-worker-depends-on

  spark-worker-b:
    <<: *spark-common
    environment:
      <<: *spark-worker-env
      SPARK_LOCAL_IP: spark-worker-b
    ports:
      - "9092:8080"
      - "7002:7000"
    depends_on:
      <<: *spark-worker-depends-on

#  demo-database:
#    image: postgres:11.7-alpine
#    ports:
#      - "5432:5432"
#    environment:
#      - POSTGRES_PASSWORD=casa1234